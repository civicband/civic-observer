{% extends "base.html" %}

{% block title %}Search Meetings - CivicObserver{% endblock %}

{% block content %}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Page Header -->
        <div class="sm:flex sm:items-center sm:justify-between mb-6">
            <div>
                {% if public_page %}
                    <h1 class="text-3xl font-bold tracking-tight text-gray-900">{{ public_page.title }}</h1>
                    {% if public_page.description %}
                        <p class="mt-2 text-sm text-gray-600">{{ public_page.description }}</p>
                    {% endif %}
                    <p class="mt-1 text-xs text-gray-500">
                        Searching for: <span class="font-semibold text-gray-700">{{ public_page.search.search_term }}</span>
                    </p>
                {% else %}
                    <h1 class="text-3xl font-bold tracking-tight text-gray-900">Search Meeting Documents</h1>
                    <p class="mt-2 text-sm text-gray-600">Search across all meeting agendas and minutes using full-text search</p>
                {% endif %}
            </div>
        </div>

        <!-- Search Interface -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6" x-data="{ filtersOpen: true }">
            <!-- Filters Sidebar -->
            <div class="lg:col-span-1">
                <!-- Mobile: Filter Toggle Button -->
                <button @click="filtersOpen = !filtersOpen"
                        type="button"
                        class="lg:hidden w-full mb-4 inline-flex items-center justify-between px-4 py-3 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors"
                        :aria-expanded="filtersOpen.toString()">
                    <span class="flex items-center">
                        <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                        </svg>
                        <span x-text="filtersOpen ? 'Hide Filters' : 'Show Filters'"></span>
                    </span>
                    <svg class="w-5 h-5 text-gray-400 transform transition-transform"
                         :class="{ 'rotate-180': filtersOpen }"
                         fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>

                <!-- Filter Panel (Collapsible on mobile, always visible on desktop) -->
                <div x-show="filtersOpen"
                     x-transition:enter="transition ease-out duration-150"
                     x-transition:enter-start="opacity-0 -translate-y-2"
                     x-transition:enter-end="opacity-100 translate-y-0"
                     x-transition:leave="transition ease-in duration-100"
                     x-transition:leave-start="opacity-100 translate-y-0"
                     x-transition:leave-end="opacity-0 -translate-y-2"
                     x-cloak
                     class="lg:!block bg-white shadow-lg rounded-xl p-4 lg:sticky lg:top-20">
                    <h2 class="text-lg font-semibold text-gray-900 mb-3">Search</h2>
                    <form id="search-form"
                          method="get"
                          action="{% url 'meetings:meeting-search-results' %}"
                          hx-get="{% url 'meetings:meeting-search-results' %}"
                          hx-target="#search-results"
                          hx-swap="innerHTML show:top"
                          hx-indicator="#search-loading"
                          {% if public_page %}hx-vals='{"public_page_slug": "{{ public_page.slug }}"}'{% endif %}
                          aria-label="Meeting document search filters"
                          role="search">

                        {% if public_page %}
                            {# Pass public page slug for server-side scope enforcement #}
                            <input type="hidden" name="public_page_slug" value="{{ public_page.slug }}">
                        {% endif %}

                        <!-- Search Query (Essential) -->
                        <div class="mb-3">
                            {% if lock_search_term %}
                                <input type="hidden" name="query" value="{{ form.query.value }}">
                                <div class="px-4 py-3 bg-indigo-50 border border-indigo-200 rounded-lg">
                                    <p class="text-sm font-medium text-indigo-900">Fixed Search Term</p>
                                    <p class="text-sm text-indigo-700 mt-1">{{ form.query.value }}</p>
                                    <p class="text-xs text-indigo-600 mt-1">Use filters below to refine results</p>
                                </div>
                            {% else %}
                                <label for="id_query" class="block text-sm font-medium text-gray-700 mb-2">
                                    Search Query
                                    <span class="text-red-500" aria-label="required">*</span>
                                </label>
                                {{ form.query }}
                                <p id="query-help-text" class="mt-1 text-xs text-gray-500">
                                    Use quotes for exact phrases. Supports AND, OR, NOT operators.
                                </p>
                            {% endif %}
                        </div>

                        <!-- Municipalities Multi-Select Filter -->
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Municipalities
                            </label>
                            <div x-data="multiSelect({
                                         name: 'municipalities',
                                         items: [{% for muni in form.municipalities.field.queryset %}{'id': '{{ muni.id }}', 'label': '{{ muni.name|escapejs }}, {{ muni.state|escapejs }}'}{% if not forloop.last %},{% endif %}{% endfor %}],
                                         placeholder: 'Search municipalities...'
                                         })" class="relative">
                        <!-- Hidden inputs for form submission -->
                                <template x-for="selectedId in selected" :key="selectedId">
                                    <input type="hidden" name="municipalities" :value="selectedId">
                                </template>

                        <!-- Selected tags display -->
                                <div class="flex flex-wrap gap-2 mb-2" x-show="selected.length > 0">
                                    <template x-for="selectedId in selected" :key="selectedId">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
                                            <span x-text="items.find(i => i.id === selectedId)?.label"></span>
                                            <button type="button" @click="removeItem(selectedId)" class="ml-1.5 inline-flex items-center justify-center w-4 h-4 text-indigo-600 hover:text-indigo-800 focus:outline-none">
                                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                                </svg>
                                            </button>
                                        </span>
                                    </template>
                                </div>

                        <!-- Dropdown toggle button -->
                                <button type="button" @click="open = !open" class="w-full px-4 py-2 text-left border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white flex items-center justify-between" :aria-expanded="open">
                                    <span x-text="selected.length > 0 ? selected.length + ' selected' : 'All municipalities'" class="text-gray-700"></span>
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>

                        <!-- Dropdown menu -->
                                <div x-show="open" @click.away="open = false" x-transition class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-hidden">
                            <!-- Search input -->
                                    <div class="p-2 border-b border-gray-200">
                                        <input type="text" x-model="search" @keydown.escape="open = false" placeholder="Search..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>

                            <!-- Options list -->
                                    <div class="overflow-y-auto max-h-48">
                                        <template x-for="item in filteredItems" :key="item.id">
                                            <button type="button" @click="toggleItem(item.id)" class="w-full px-4 py-2 text-left hover:bg-indigo-50 flex items-center justify-between" :class="{'bg-indigo-50': selected.includes(item.id)}">
                                                <span x-text="item.label"></span>
                                                <svg x-show="selected.includes(item.id)" class="w-5 h-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                                </svg>
                                            </button>
                                        </template>
                                        <div x-show="filteredItems.length === 0" class="px-4 py-8 text-center text-gray-500">
                                            No municipalities found
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- States Multi-Select Filter -->
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                States/Regions
                            </label>
                            <div x-data="multiSelect({
                                         name: 'states',
                                         items: [{% for code, name in form.states.field.choices %}{'id': '{{ code|escapejs }}', 'label': '{{ code|escapejs }} - {{ name|escapejs }}'}{% if not forloop.last %},{% endif %}{% endfor %}],
                                         placeholder: 'Search states...'
                                         })" class="relative">
                        <!-- Hidden inputs for form submission -->
                                <template x-for="selectedId in selected" :key="selectedId">
                                    <input type="hidden" name="states" :value="selectedId">
                                </template>

                        <!-- Selected tags display -->
                                <div class="flex flex-wrap gap-2 mb-2" x-show="selected.length > 0">
                                    <template x-for="selectedId in selected" :key="selectedId">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
                                            <span x-text="items.find(i => i.id === selectedId)?.label"></span>
                                            <button type="button" @click="removeItem(selectedId)" class="ml-1.5 inline-flex items-center justify-center w-4 h-4 text-indigo-600 hover:text-indigo-800 focus:outline-none">
                                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                                </svg>
                                            </button>
                                        </span>
                                    </template>
                                </div>

                        <!-- Dropdown toggle button -->
                                <button type="button" @click="open = !open" class="w-full px-4 py-2 text-left border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white flex items-center justify-between" :aria-expanded="open">
                                    <span x-text="selected.length > 0 ? selected.length + ' selected' : 'All states/regions'" class="text-gray-700"></span>
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>

                        <!-- Dropdown menu -->
                                <div x-show="open" @click.away="open = false" x-transition class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-hidden">
                            <!-- Search input -->
                                    <div class="p-2 border-b border-gray-200">
                                        <input type="text" x-model="search" @keydown.escape="open = false" placeholder="Search..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>

                            <!-- Options list -->
                                    <div class="overflow-y-auto max-h-48">
                                        <template x-for="item in filteredItems" :key="item.id">
                                            <button type="button" @click="toggleItem(item.id)" class="w-full px-4 py-2 text-left hover:bg-indigo-50 flex items-center justify-between" :class="{'bg-indigo-50': selected.includes(item.id)}">
                                                <span x-text="item.label"></span>
                                                <svg x-show="selected.includes(item.id)" class="w-5 h-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                                </svg>
                                            </button>
                                        </template>
                                        <div x-show="filteredItems.length === 0" class="px-4 py-8 text-center text-gray-500">
                                            No states/regions found
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Search Button (Always Visible) -->
                        <button type="submit" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            Search
                        </button>

                        {% if user.is_authenticated %}
                        <!-- Save Search Button (Authenticated Users Only) -->
                            <button type="button"
                                    @click="$dispatch('open-save-search-modal')"
                                    class="mt-2 w-full inline-flex justify-center items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                                </svg>
                                Save This Search
                            </button>
                        {% endif %}

                        <div class="border-t border-gray-200 my-3"></div>

                        <!-- Advanced Filters (Collapsible) -->
                        <div x-data="{ showAdvanced: false }" class="mb-3">
                            <button type="button" @click="showAdvanced = !showAdvanced" class="w-full flex items-center justify-between text-sm font-medium text-gray-700 hover:text-gray-900 focus:outline-none">
                                <span class="flex items-center">
                                    <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                                    </svg>
                                    Advanced Filters
                                </span>
                                <svg :class="{'rotate-180': showAdvanced}" class="w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>

                            <!-- Advanced Filters Content -->
                            <div x-show="showAdvanced" x-collapse class="mt-3 space-y-3">
                                <!-- Date Range Filters (Inline) -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Date Range
                                    </label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label for="id_date_from" class="block text-xs text-gray-500 mb-1">From</label>
                                            {{ form.date_from }}
                                        </div>
                                        <div>
                                            <label for="id_date_to" class="block text-xs text-gray-500 mb-1">To</label>
                                            {{ form.date_to }}
                                        </div>
                                    </div>
                                </div>

                                <!-- Document Type -->
                                <div>
                                    <label for="id_document_type" class="block text-sm font-medium text-gray-700 mb-2">
                                        Document Type
                                    </label>
                                    {{ form.document_type }}
                                </div>

                                <!-- Meeting Name Filter -->
                                <div>
                                    <label for="id_meeting_name_query" class="block text-sm font-medium text-gray-700 mb-2">
                                        Meeting Name
                                    </label>
                                    {{ form.meeting_name_query }}
                                    <p id="meeting-name-help-text" class="mt-1 text-xs text-gray-500">
                                        Filter by meeting name (e.g., planning OR zoning)
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Clear Filters -->
                        <button type="button" onclick="clearFilters()" class="mt-2 w-full inline-flex justify-center items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Clear Filters
                        </button>
                    </form>
                </div>
            </div>

            <!-- Search Results Area -->
            <div class="lg:col-span-3">
                <!-- Results Container with ARIA live region -->
                <div id="search-results"
                     class="min-h-[400px] relative"
                     role="status"
                     aria-live="polite"
                     aria-atomic="true">
                    <!-- Initial empty state -->
                    <div class="text-center py-12 bg-white shadow-lg rounded-xl">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <h3 class="mt-4 text-lg font-medium text-gray-900">Start Searching</h3>
                        <p class="mt-2 text-gray-500">Enter keywords and click Search to find meeting documents, or use filters to browse by municipality and date.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if user.is_authenticated %}
    <!-- Save Search Modal -->
        <div x-data="saveSearchModal()"
             @open-save-search-modal.window="openModal()"
             @keydown.escape.window="open = false"
             x-show="open"
             x-cloak
             class="fixed inset-0 z-50 overflow-y-auto"
             aria-labelledby="modal-title"
             role="dialog"
             aria-modal="true">
        <!-- Background overlay -->
            <div x-show="open"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
                 @click="open = false"
                 aria-hidden="true"></div>

        <!-- Modal panel -->
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div x-show="open"
                     x-transition:enter="ease-out duration-300"
                     x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                     x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                     x-transition:leave="ease-in duration-200"
                     x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                     x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                     class="relative transform overflow-hidden rounded-lg bg-white px-4 pb-4 pt-5 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg sm:p-6"
                     @click.stop>
                <!-- Modal content -->
                    <div>
                        <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-indigo-100">
                            <svg class="h-6 w-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path>
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-5">
                            <h3 class="text-lg font-semibold leading-6 text-gray-900" id="modal-title">
                                Save This Search
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">
                                    Get notified when new meeting documents match your search criteria.
                                </p>
                            </div>
                        </div>
                    </div>

                <!-- Save Search Form -->
                    <form id="save-search-form" class="mt-5 sm:mt-6 text-left" @submit.prevent="submitSaveSearch">
                    <!-- Error/Success Messages -->
                        <div x-show="message"
                             x-transition
                             :class="isError ? 'bg-red-50 border-red-200 text-red-800' : 'bg-green-50 border-green-200 text-green-800'"
                             class="mb-4 p-3 border rounded-md text-sm"
                             role="alert">
                            <span x-text="message"></span>
                        </div>

                    <!-- Search Name -->
                        <div class="mb-4">
                            <label for="save-search-name" class="block text-sm font-medium text-gray-700 mb-2">
                                Search Name <span class="text-red-500">*</span>
                            </label>
                            <input type="text"
                                   id="save-search-name"
                                   name="name"
                                   required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                   placeholder="e.g., Budget Updates">
                        </div>

                    <!-- Notification Frequency -->
                        <div class="mb-4">
                            <label for="save-search-frequency" class="block text-sm font-medium text-gray-700 mb-2">
                                Notification Frequency <span class="text-red-500">*</span>
                            </label>
                            <select id="save-search-frequency"
                                    name="notification_frequency"
                                    required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="immediate">Immediate - Get notified as soon as new results appear</option>
                                <option value="daily">Daily Digest - Get a daily summary of new results</option>
                                <option value="weekly">Weekly Digest - Get a weekly summary of new results</option>
                            </select>
                        </div>

                    <!-- Current Search Summary -->
                        <div class="bg-gray-50 rounded-md p-3 text-sm">
                            <p class="font-medium text-gray-700 mb-1">Search Parameters:</p>
                            <div id="search-summary" class="text-gray-600 space-y-1">
                            <!-- Will be populated by JavaScript -->
                            </div>
                        </div>
                    </form>

                <!-- Modal actions -->
                    <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                        <button type="submit"
                                form="save-search-form"
                                :disabled="loading"
                                class="inline-flex w-full justify-center items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-600 disabled:opacity-50 disabled:cursor-not-allowed sm:col-start-2">
                            <svg x-show="loading" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span x-text="loading ? 'Saving...' : 'Save Search'"></span>
                        </button>
                        <button type="button"
                                @click="open = false"
                                class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-600 sm:col-start-1 sm:mt-0">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <script>
        // Alpine.js multi-select component
        function multiSelect(config) {
            return {
                name: config.name,
                items: config.items,
                placeholder: config.placeholder || 'Search...',
                selected: [],
                search: '',
                open: false,

                init() {
                    // Listen for clear-filters event
                    window.addEventListener('clear-filters', () => {
                        this.selected = [];
                        this.search = '';
                        this.open = false;
                    });
                },

                get filteredItems() {
                    if (!this.search) {
                        return this.items;
                    }
                    const searchLower = this.search.toLowerCase();
                    return this.items.filter(item =>
                        item.label.toLowerCase().includes(searchLower)
                    );
                },

                toggleItem(id) {
                    const index = this.selected.indexOf(id);
                    if (index === -1) {
                        this.selected.push(id);
                    } else {
                        this.selected.splice(index, 1);
                    }
                },

                removeItem(id) {
                    const index = this.selected.indexOf(id);
                    if (index !== -1) {
                        this.selected.splice(index, 1);
                    }
                }
            };
        }

        // Save Search Modal component
        function saveSearchModal() {
            return {
                open: false,
                loading: false,
                message: '',
                isError: false,

                openModal() {
                    this.open = true;
                    this.message = '';
                    this.isError = false;
                    this.populateSearchSummary();

                    // Focus on name input after modal opens
                    setTimeout(() => {
                        document.getElementById('save-search-name').focus();
                    }, 100);
                },

                populateSearchSummary() {
                    const form = document.getElementById('search-form');
                    const formData = new FormData(form);
                    const summary = [];

                    // Query
                    const query = formData.get('query');
                    if (query && query.trim()) {
                        summary.push(`<strong>Search:</strong> "${query}"`);
                    } else {
                        summary.push(`<strong>Mode:</strong> All updates`);
                    }

                    // Municipalities
                    const municipalities = formData.getAll('municipalities');
                    if (municipalities.length > 0) {
                        summary.push(`<strong>Municipalities:</strong> ${municipalities.length} selected`);
                    }

                    // States
                    const states = formData.getAll('states');
                    if (states.length > 0) {
                        summary.push(`<strong>States:</strong> ${states.length} selected`);
                    }

                    // Date range
                    const dateFrom = formData.get('date_from');
                    const dateTo = formData.get('date_to');
                    if (dateFrom || dateTo) {
                        const range = `${dateFrom || 'start'} to ${dateTo || 'end'}`;
                        summary.push(`<strong>Date Range:</strong> ${range}`);
                    }

                    // Document type
                    const docType = formData.get('document_type');
                    if (docType && docType !== 'all') {
                        summary.push(`<strong>Document Type:</strong> ${docType}`);
                    }

                    // Meeting name
                    const meetingName = formData.get('meeting_name_query');
                    if (meetingName && meetingName.trim()) {
                        summary.push(`<strong>Meeting Name:</strong> ${meetingName}`);
                    }

                    document.getElementById('search-summary').innerHTML =
                        summary.length > 0 ? summary.join('<br>') : 'No filters applied';
                },

                async submitSaveSearch(event) {
                    event.preventDefault();

                    if (this.loading) return;

                    this.loading = true;
                    this.message = '';
                    this.isError = false;

                    try {
                        // Get search form data
                        const searchForm = document.getElementById('search-form');
                        const searchFormData = new FormData(searchForm);

                        // Get save form data
                        const saveForm = document.getElementById('save-search-form');
                        const saveFormData = new FormData(saveForm);

                        // Combine data
                        const data = new FormData();
                        data.append('name', saveFormData.get('name'));
                        data.append('notification_frequency', saveFormData.get('notification_frequency'));

                        // Copy search parameters
                        for (let [key, value] of searchFormData.entries()) {
                            data.append(key, value);
                        }

                        // Submit to endpoint
                        const response = await fetch('{% url "searches:save-search-from-params" %}', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            body: data
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            this.message = result.message;
                            this.isError = false;

                            // Close modal after 1.5 seconds and redirect to saved searches
                            setTimeout(() => {
                                this.open = false;
                                window.location.href = '{% url "searches:savedsearch-list" %}';
                            }, 1500);
                        } else {
                            this.message = result.error || 'Failed to save search';
                            this.isError = true;
                        }
                    } catch (error) {
                        this.message = 'An error occurred while saving the search';
                        this.isError = true;
                        console.error('Save search error:', error);
                    } finally {
                        this.loading = false;
                    }
                }
            };
        }

        function clearFilters() {
            // Reset form (filters in sidebar)
            const form = document.getElementById('search-form');
            form.reset();

            // Clear search query inputs
            const queryInput = document.getElementById('id_query');
            if (queryInput) {
                queryInput.value = '';
            }
            const meetingNameInput = document.getElementById('id_meeting_name_query');
            if (meetingNameInput) {
                meetingNameInput.value = '';
            }

            // Clear Alpine.js multi-select components by dispatching event
            // Alpine components will listen and clear their selected arrays
            window.dispatchEvent(new CustomEvent('clear-filters'));

            // Clear results - show empty state
            document.getElementById('search-results').innerHTML = `
                <div class="text-center py-12 bg-white shadow-lg rounded-xl">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <h3 class="mt-4 text-lg font-medium text-gray-900">Start Searching</h3>
                    <p class="mt-2 text-gray-500">Enter keywords and click Search to find meeting documents, or use filters to browse by municipality and date.</p>
                </div>
            `;

            // Return focus to search input
            if (queryInput) {
                queryInput.focus();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('search-form');
            const queryInput = document.getElementById('id_query');
            const resultsContainer = document.getElementById('search-results');

            // Trigger search on page load if there are existing params OR if this is a public page
            const urlParams = new URLSearchParams(window.location.search);
            const hasParams = urlParams.has('query') || urlParams.has('meeting_name_query') || urlParams.has('municipalities') || urlParams.has('states') || urlParams.has('date_from') || urlParams.has('date_to') || urlParams.has('document_type');
            const autoExecute = {% if auto_execute_search %}true{% else %}false{% endif %};

            console.log('[Auto-Execute Debug] hasParams:', hasParams, 'autoExecute:', autoExecute);

            // Auto-expand advanced filters if any advanced filter params are present
            // Note: municipalities and states are now outside the drawer, so only check for date range, document type, and meeting name
            const hasAdvancedParams = urlParams.has('date_from') || urlParams.has('date_to') || urlParams.has('document_type') || urlParams.has('meeting_name_query');
            if (hasAdvancedParams) {
                // Wait for Alpine.js to initialize, then expand advanced section
                setTimeout(() => {
                    const advancedSection = document.querySelector('[x-data*="showAdvanced"]');
                    if (advancedSection && advancedSection.__x) {
                        advancedSection.__x.$data.showAdvanced = true;
                    }
                }, 100);
            }

            // Function to trigger search with HTMX (with fallback)
            function triggerSearch() {
                console.log('[Auto-Execute Debug] Triggering search, htmx available:', typeof htmx !== 'undefined');
                const formElement = document.getElementById('search-form');

                if (!formElement) {
                    console.error('[Auto-Execute Debug] Form element not found!');
                    return;
                }

                // Check if HTMX is loaded and ready
                if (typeof htmx !== 'undefined') {
                    console.log('[Auto-Execute Debug] Using HTMX - triggering request via form.requestSubmit()');
                    // Trigger HTMX request by submitting the form
                    // HTMX will intercept the submit event and handle it via the hx-get attribute
                    formElement.requestSubmit();
                } else {
                    // HTMX not loaded - wait a bit and retry, or fall back to form submit
                    console.log('[Auto-Execute Debug] HTMX not ready, waiting 500ms...');
                    setTimeout(() => {
                        if (typeof htmx !== 'undefined') {
                            console.log('[Auto-Execute Debug] HTMX ready after delay, triggering via requestSubmit()');
                            formElement.requestSubmit();
                        } else {
                            // Final fallback: submit the form normally
                            console.warn('HTMX not available, falling back to regular form submission');
                            formElement.submit();
                        }
                    }, 500);
                }
            }

            if (hasParams || autoExecute) {
                console.log('[Auto-Execute Debug] Condition met, calling triggerSearch()');
                triggerSearch();
            } else {
                console.log('[Auto-Execute Debug] Condition NOT met, not triggering search');
            }

            // Keyboard shortcut: / to focus search
            document.addEventListener('keydown', function(e) {
                // Don't trigger if user is typing in an input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    // ESC to clear filters when in input
                    if (e.key === 'Escape') {
                        clearFilters();
                    }
                    return;
                }

                // / key to focus search
                if (e.key === '/') {
                    e.preventDefault();
                    if (queryInput) {
                        queryInput.focus();
                    }
                }
            });

            // HTMX event listeners for accessibility
            document.body.addEventListener('htmx:beforeRequest', function(evt) {
                // Set aria-busy on results container
                if (resultsContainer && evt.detail.target === resultsContainer) {
                    resultsContainer.setAttribute('aria-busy', 'true');

                    // Show loading state
                    const loadingHTML = `
                        <div class="loading-overlay" role="alert" aria-live="assertive">
                            <div class="text-center">
                                <svg class="inline-block animate-spin h-12 w-12 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <p class="mt-4 text-sm font-medium text-gray-700">Searching meeting documents...</p>
                                <p class="mt-1 text-xs text-gray-500">This may take a few moments</p>
                                <span class="sr-only">Loading results, please wait</span>
                            </div>
                        </div>
                    `;

                    // Prepend loading overlay if not already present
                    if (!resultsContainer.querySelector('.loading-overlay')) {
                        resultsContainer.insertAdjacentHTML('afterbegin', loadingHTML);
                    }
                }
            });

            document.body.addEventListener('htmx:afterRequest', function(evt) {
                // Remove aria-busy
                if (resultsContainer && evt.detail.target === resultsContainer) {
                    resultsContainer.setAttribute('aria-busy', 'false');
                }
            });

            // Focus management: focus first result after load
            document.body.addEventListener('htmx:afterSwap', function(evt) {
                if (evt.detail.target === resultsContainer) {
                    // Find first focusable result link
                    const firstResult = resultsContainer.querySelector('a[href^="https://"]');
                    if (firstResult) {
                        // Announce result count to screen readers
                        const resultCount = resultsContainer.querySelector('[aria-label*="results"]');
                        if (resultCount) {
                            // Screen reader will announce via aria-live region
                        }
                    }
                }
            });
        });
    </script>

    <style>
        /* Loading state overlay */
        .loading-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(2px);
            z-index: 10;
        }

        /* Disable form during loading */
        .htmx-request #search-form {
            pointer-events: none;
            opacity: 0.7;
        }

        /* Focus visible styles for accessibility */
        *:focus-visible {
            outline: 2px solid #4F46E5;
            outline-offset: 2px;
        }

        /* Skip to results link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #4F46E5;
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 100;
        }

        .skip-link:focus {
            top: 0;
        }
    </style>
{% endblock content %}
