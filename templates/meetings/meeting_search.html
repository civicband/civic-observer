{% extends "base.html" %}

{% block title %}Search Meetings - CivicObserver{% endblock %}

{% block content %}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Header -->
        <div class="sm:flex sm:items-center sm:justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold tracking-tight text-gray-900">Search Meeting Documents</h1>
                <p class="mt-2 text-sm text-gray-600">Search across all meeting agendas and minutes using full-text search</p>
            </div>
        </div>

        <!-- Search Interface -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Filters Sidebar -->
            <div class="lg:col-span-1">
                <div class="bg-white shadow-lg rounded-xl p-6 sticky top-20">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Search</h2>
                    <form id="search-form"
                          hx-get="{% url 'meetings:meeting-search-results' %}"
                          hx-target="#search-results"
                          hx-swap="innerHTML show:top"
                          aria-label="Meeting document search filters"
                          role="search">

                        <!-- Search Query -->
                        <div class="mb-4">
                            <label for="id_query" class="block text-sm font-medium text-gray-700 mb-2">
                                Search Query
                                <span class="text-red-500" aria-label="required">*</span>
                            </label>
                            {{ form.query }}
                            <p id="query-help-text" class="mt-1 text-xs text-gray-500">
                                Use quotes for exact phrases. Supports AND, OR, NOT operators.
                            </p>
                        </div>

                        <!-- Meeting Name Filter -->
                        <div class="mb-4">
                            <label for="id_meeting_name_query" class="block text-sm font-medium text-gray-700 mb-2">
                                Meeting Name (optional)
                            </label>
                            {{ form.meeting_name_query }}
                            <p id="meeting-name-help-text" class="mt-1 text-xs text-gray-500">
                                Filter by meeting name (e.g., planning OR zoning)
                            </p>
                        </div>

                        <div class="border-t border-gray-200 my-4"></div>

                        <!-- Municipalities Multi-Select Filter -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Municipalities
                            </label>
                            <div x-data="multiSelect({
                                         name: 'municipalities',
                                         items: [{% for muni in form.municipalities.field.queryset %}{'id': '{{ muni.id }}', 'label': '{{ muni.name }}, {{ muni.state }}'}{% if not forloop.last %},{% endif %}{% endfor %}],
                                         placeholder: 'Search municipalities...'
                                         })" class="relative">
                                <!-- Hidden inputs for form submission -->
                                <template x-for="selectedId in selected" :key="selectedId">
                                    <input type="hidden" name="municipalities" :value="selectedId">
                                </template>

                                <!-- Selected tags display -->
                                <div class="flex flex-wrap gap-2 mb-2" x-show="selected.length > 0">
                                    <template x-for="selectedId in selected" :key="selectedId">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
                                            <span x-text="items.find(i => i.id === selectedId)?.label"></span>
                                            <button type="button" @click="removeItem(selectedId)" class="ml-1.5 inline-flex items-center justify-center w-4 h-4 text-indigo-600 hover:text-indigo-800 focus:outline-none">
                                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                                </svg>
                                            </button>
                                        </span>
                                    </template>
                                </div>

                                <!-- Dropdown toggle button -->
                                <button type="button" @click="open = !open" class="w-full px-4 py-2 text-left border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white flex items-center justify-between" :aria-expanded="open">
                                    <span x-text="selected.length > 0 ? selected.length + ' selected' : 'All municipalities'" class="text-gray-700"></span>
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>

                                <!-- Dropdown menu -->
                                <div x-show="open" @click.away="open = false" x-transition class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-hidden">
                                    <!-- Search input -->
                                    <div class="p-2 border-b border-gray-200">
                                        <input type="text" x-model="search" @keydown.escape="open = false" placeholder="Search..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>

                                    <!-- Options list -->
                                    <div class="overflow-y-auto max-h-48">
                                        <template x-for="item in filteredItems" :key="item.id">
                                            <button type="button" @click="toggleItem(item.id)" class="w-full px-4 py-2 text-left hover:bg-indigo-50 flex items-center justify-between" :class="{'bg-indigo-50': selected.includes(item.id)}">
                                                <span x-text="item.label"></span>
                                                <svg x-show="selected.includes(item.id)" class="w-5 h-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                                </svg>
                                            </button>
                                        </template>
                                        <div x-show="filteredItems.length === 0" class="px-4 py-8 text-center text-gray-500">
                                            No municipalities found
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- States Multi-Select Filter -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                States/Regions
                            </label>
                            <div x-data="multiSelect({
                                         name: 'states',
                                         items: [{% for code, name in form.states.field.choices %}{'id': '{{ code }}', 'label': '{{ code }} - {{ name }}'}{% if not forloop.last %},{% endif %}{% endfor %}],
                                         placeholder: 'Search states...'
                                         })" class="relative">
                                <!-- Hidden inputs for form submission -->
                                <template x-for="selectedId in selected" :key="selectedId">
                                    <input type="hidden" name="states" :value="selectedId">
                                </template>

                                <!-- Selected tags display -->
                                <div class="flex flex-wrap gap-2 mb-2" x-show="selected.length > 0">
                                    <template x-for="selectedId in selected" :key="selectedId">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
                                            <span x-text="items.find(i => i.id === selectedId)?.label"></span>
                                            <button type="button" @click="removeItem(selectedId)" class="ml-1.5 inline-flex items-center justify-center w-4 h-4 text-indigo-600 hover:text-indigo-800 focus:outline-none">
                                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                                </svg>
                                            </button>
                                        </span>
                                    </template>
                                </div>

                                <!-- Dropdown toggle button -->
                                <button type="button" @click="open = !open" class="w-full px-4 py-2 text-left border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white flex items-center justify-between" :aria-expanded="open">
                                    <span x-text="selected.length > 0 ? selected.length + ' selected' : 'All states/regions'" class="text-gray-700"></span>
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>

                                <!-- Dropdown menu -->
                                <div x-show="open" @click.away="open = false" x-transition class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-hidden">
                                    <!-- Search input -->
                                    <div class="p-2 border-b border-gray-200">
                                        <input type="text" x-model="search" @keydown.escape="open = false" placeholder="Search..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>

                                    <!-- Options list -->
                                    <div class="overflow-y-auto max-h-48">
                                        <template x-for="item in filteredItems" :key="item.id">
                                            <button type="button" @click="toggleItem(item.id)" class="w-full px-4 py-2 text-left hover:bg-indigo-50 flex items-center justify-between" :class="{'bg-indigo-50': selected.includes(item.id)}">
                                                <span x-text="item.label"></span>
                                                <svg x-show="selected.includes(item.id)" class="w-5 h-5 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                                </svg>
                                            </button>
                                        </template>
                                        <div x-show="filteredItems.length === 0" class="px-4 py-8 text-center text-gray-500">
                                            No states/regions found
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Date Range Filters -->
                        <div class="mb-4">
                            <label for="id_date_from" class="block text-sm font-medium text-gray-700 mb-2">
                                Date From
                            </label>
                            {{ form.date_from }}
                        </div>

                        <div class="mb-4">
                            <label for="id_date_to" class="block text-sm font-medium text-gray-700 mb-2">
                                Date To
                            </label>
                            {{ form.date_to }}
                        </div>

                        <!-- Document Type Filter -->
                        <div class="mb-4">
                            <label for="id_document_type" class="block text-sm font-medium text-gray-700 mb-2">
                                Document Type
                            </label>
                            {{ form.document_type }}
                        </div>

                        <!-- Search Button -->
                        <button type="submit" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            Search
                        </button>

                        <!-- Clear Filters -->
                        <button type="button" onclick="clearFilters()" class="mt-2 w-full inline-flex justify-center items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            Clear Filters
                        </button>
                    </form>
                </div>
            </div>

            <!-- Search Results Area -->
            <div class="lg:col-span-3">
                <!-- Results Container with ARIA live region -->
                <div id="search-results"
                     class="min-h-[400px] relative"
                     role="status"
                     aria-live="polite"
                     aria-atomic="true">
                    <!-- Initial empty state -->
                    <div class="text-center py-12 bg-white shadow-lg rounded-xl">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <h3 class="mt-4 text-lg font-medium text-gray-900">Start Searching</h3>
                        <p class="mt-2 text-gray-500">Enter keywords and click Search to find meeting documents, or use filters to browse by municipality and date.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Alpine.js multi-select component
        function multiSelect(config) {
            return {
                name: config.name,
                items: config.items,
                placeholder: config.placeholder || 'Search...',
                selected: [],
                search: '',
                open: false,

                init() {
                    // Listen for clear-filters event
                    window.addEventListener('clear-filters', () => {
                        this.selected = [];
                        this.search = '';
                        this.open = false;
                    });
                },

                get filteredItems() {
                    if (!this.search) {
                        return this.items;
                    }
                    const searchLower = this.search.toLowerCase();
                    return this.items.filter(item =>
                        item.label.toLowerCase().includes(searchLower)
                    );
                },

                toggleItem(id) {
                    const index = this.selected.indexOf(id);
                    if (index === -1) {
                        this.selected.push(id);
                    } else {
                        this.selected.splice(index, 1);
                    }
                },

                removeItem(id) {
                    const index = this.selected.indexOf(id);
                    if (index !== -1) {
                        this.selected.splice(index, 1);
                    }
                }
            };
        }

        function clearFilters() {
            // Reset form (filters in sidebar)
            const form = document.getElementById('search-form');
            form.reset();

            // Clear search query inputs
            const queryInput = document.getElementById('id_query');
            if (queryInput) {
                queryInput.value = '';
            }
            const meetingNameInput = document.getElementById('id_meeting_name_query');
            if (meetingNameInput) {
                meetingNameInput.value = '';
            }

            // Clear Alpine.js multi-select components by dispatching event
            // Alpine components will listen and clear their selected arrays
            window.dispatchEvent(new CustomEvent('clear-filters'));

            // Clear results - show empty state
            document.getElementById('search-results').innerHTML = `
                <div class="text-center py-12 bg-white shadow-lg rounded-xl">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <h3 class="mt-4 text-lg font-medium text-gray-900">Start Searching</h3>
                    <p class="mt-2 text-gray-500">Enter keywords and click Search to find meeting documents, or use filters to browse by municipality and date.</p>
                </div>
            `;

            // Return focus to search input
            if (queryInput) {
                queryInput.focus();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('search-form');
            const queryInput = document.getElementById('id_query');
            const resultsContainer = document.getElementById('search-results');

            // Trigger search on page load if there are existing params
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('query') || urlParams.has('meeting_name_query') || urlParams.has('municipalities') || urlParams.has('states') || urlParams.has('date_from') || urlParams.has('date_to') || urlParams.has('document_type')) {
                htmx.trigger('#search-form', 'submit');
            }

            // Keyboard shortcut: / to focus search
            document.addEventListener('keydown', function(e) {
                // Don't trigger if user is typing in an input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    // ESC to clear filters when in input
                    if (e.key === 'Escape') {
                        clearFilters();
                    }
                    return;
                }

                // / key to focus search
                if (e.key === '/') {
                    e.preventDefault();
                    if (queryInput) {
                        queryInput.focus();
                    }
                }
            });

            // HTMX event listeners for accessibility
            document.body.addEventListener('htmx:beforeRequest', function(evt) {
                // Set aria-busy on results container
                if (resultsContainer && evt.detail.target === resultsContainer) {
                    resultsContainer.setAttribute('aria-busy', 'true');

                    // Show loading state
                    const loadingHTML = `
                        <div class="loading-overlay" role="alert" aria-live="assertive">
                            <div class="text-center">
                                <svg class="inline-block animate-spin h-12 w-12 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <p class="mt-4 text-sm font-medium text-gray-700">Searching meeting documents...</p>
                                <p class="mt-1 text-xs text-gray-500">This may take a few moments</p>
                                <span class="sr-only">Loading results, please wait</span>
                            </div>
                        </div>
                    `;

                    // Prepend loading overlay if not already present
                    if (!resultsContainer.querySelector('.loading-overlay')) {
                        resultsContainer.insertAdjacentHTML('afterbegin', loadingHTML);
                    }
                }
            });

            document.body.addEventListener('htmx:afterRequest', function(evt) {
                // Remove aria-busy
                if (resultsContainer && evt.detail.target === resultsContainer) {
                    resultsContainer.setAttribute('aria-busy', 'false');
                }
            });

            // Focus management: focus first result after load
            document.body.addEventListener('htmx:afterSwap', function(evt) {
                if (evt.detail.target === resultsContainer) {
                    // Find first focusable result link
                    const firstResult = resultsContainer.querySelector('a[href^="https://"]');
                    if (firstResult) {
                        // Announce result count to screen readers
                        const resultCount = resultsContainer.querySelector('[aria-label*="results"]');
                        if (resultCount) {
                            // Screen reader will announce via aria-live region
                        }
                    }
                }
            });
        });
    </script>

    <style>
        /* Loading state overlay */
        .loading-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(2px);
            z-index: 10;
        }

        /* Disable form during loading */
        .htmx-request #search-form {
            pointer-events: none;
            opacity: 0.7;
        }

        /* Focus visible styles for accessibility */
        *:focus-visible {
            outline: 2px solid #4F46E5;
            outline-offset: 2px;
        }

        /* Skip to results link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #4F46E5;
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 100;
        }

        .skip-link:focus {
            top: 0;
        }
    </style>
{% endblock content %}
