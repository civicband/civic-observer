# Civic Observer PostgreSQL Configuration - FTS Optimized
# For 8GB Docker allocation (adjust for production 64GB server)
#
# These settings are optimized for full-text search workloads with:
# - High read volume (search queries)
# - Moderate write volume (document indexing)
# - SSD storage
# - Read-heavy workload pattern

# -----------------------------
# Memory Configuration
# -----------------------------

# shared_buffers: PostgreSQL's internal buffer cache
# Rule: 25% of available RAM
# Impact: Reduces disk I/O by caching frequently accessed pages
shared_buffers = 2GB

# work_mem: Memory for sort operations and hash tables (PER OPERATION)
# Critical for preventing "lossy" bitmap heap scans in FTS queries
# Rule: Start at 64MB, increase if you see "lossy" in EXPLAIN output
# Impact: Prevents scanning extra heap pages during bitmap index scans
work_mem = 64MB

# maintenance_work_mem: Memory for VACUUM, CREATE INDEX, etc.
# Rule: 10-20% of RAM, up to 2GB
# Impact: Dramatically speeds up GIN index builds and REINDEX operations
maintenance_work_mem = 512MB

# effective_cache_size: Estimate of OS + PostgreSQL cache (planner hint)
# Rule: 75% of total RAM
# Impact: Helps query planner decide whether to use index scans
effective_cache_size = 6GB

# -----------------------------
# SSD Optimization
# -----------------------------

# random_page_cost: Cost estimate for random disk I/O
# Default: 4.0 (assumes HDD with high seek time)
# SSD: 1.1 (random access nearly as fast as sequential)
# Impact: Makes planner prefer index scans over sequential scans
random_page_cost = 1.1

# effective_io_concurrency: Number of concurrent I/O operations
# Default: 1 (HDD can't handle parallel seeks)
# SSD: 200+ (can handle many concurrent operations)
# Impact: Enables bitmap heap scan prefetching for faster queries
effective_io_concurrency = 200

# -----------------------------
# Query Optimization
# -----------------------------

# jit: Just-In-Time compilation of queries
# Default: on (PostgreSQL 11+)
# FTS: OFF - JIT adds 50-200ms compilation overhead per query
# Impact: Eliminates JIT overhead for fast OLTP/FTS queries
# Note: JIT helps long-running analytical queries, hurts short queries
jit = off

# default_statistics_target: Column statistics sample size
# Default: 100
# Higher: Better query plans for complex filters
# Impact: Improves planner accuracy for multi-column filters
default_statistics_target = 100

# -----------------------------
# Connection Settings
# -----------------------------

# max_connections: Maximum concurrent connections
# Note: When using PgBouncer, keep this moderate (100-200)
# Each connection uses ~10MB RAM
max_connections = 100

# -----------------------------
# Write-Ahead Log (WAL)
# -----------------------------

# wal_buffers: Amount of shared memory for WAL data
# Rule: Auto (defaults to 3% of shared_buffers)
# Impact: Minimal for read-heavy workloads
wal_buffers = -1

# checkpoint_completion_target: Spread checkpoint I/O over time
# Default: 0.5 (complete checkpoint in 50% of checkpoint interval)
# Higher: Spreads I/O more, reduces spikes
checkpoint_completion_target = 0.9

# -----------------------------
# Query Planner
# -----------------------------

# enable_partitionwise_join: Enable partition-wise joins
# Default: off
# Note: Useful if/when we partition by date
enable_partitionwise_join = off

# enable_partitionwise_aggregate: Enable partition-wise aggregation
# Default: off
# Note: Useful if/when we partition by date
enable_partitionwise_aggregate = off

# -----------------------------
# Logging (development)
# -----------------------------

# log_statement: Log statements
# Options: none, ddl, mod, all
# Development: ddl (log schema changes)
# Production: none (use pg_stat_statements instead)
log_statement = 'ddl'

# log_duration: Log duration of completed statements
# Development: off (use EXPLAIN manually)
# Production: off (use auto_explain for slow queries)
log_duration = off

# log_min_duration_statement: Log slow queries
# Development: -1 (disabled)
# Production: 1000 (log queries > 1 second)
log_min_duration_statement = -1

# -----------------------------
# Autovacuum (global defaults)
# -----------------------------
# Note: Per-table settings in migration 0009_tune_autovacuum.py
# override these for meetings_meetingpage table

autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min

# -----------------------------
# Locale and Formatting
# -----------------------------

# Use C locale for speed (we handle i18n in application)
lc_messages = 'C'
lc_monetary = 'C'
lc_numeric = 'C'
lc_time = 'C'

# Default text search config (overridden by queries using 'simple')
default_text_search_config = 'pg_catalog.simple'

# -----------------------------
# Extensions
# -----------------------------

# shared_preload_libraries: Extensions loaded at server start
# pg_stat_statements: Track query performance
# Note: Requires CREATE EXTENSION pg_stat_statements; after enabling
shared_preload_libraries = 'pg_stat_statements'

# pg_stat_statements configuration
pg_stat_statements.max = 10000
pg_stat_statements.track = all
