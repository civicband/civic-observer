;; PgBouncer configuration for Civic Observer
;; Optimized for Django with transaction pooling
;; Generated: 2025-11-19

[databases]
;; Database connection configuration
;; Format: dbname = host=hostname port=port dbname=dbname
postgres = host=db port=5432 dbname=postgres

[pgbouncer]
;; Listen address and port
;; CRITICAL: Must listen on 0.0.0.0 for Docker networking
listen_addr = 0.0.0.0
listen_port = 6432

;; Authentication configuration
;; Using trust to match PostgreSQL POSTGRES_HOST_AUTH_METHOD=trust
auth_type = trust
auth_file = /etc/pgbouncer/userlist.txt

;; Connection pool configuration
;; pool_mode = transaction is optimal for Django (allows connection reuse between transactions)
pool_mode = transaction

;; Maximum number of client connections allowed
max_client_conn = 200

;; Default number of server connections per database-user pair
;; Keep this low - pgBouncer's job is to pool connections efficiently
default_pool_size = 25

;; Additional server connections to allow for sudden load spikes
reserve_pool_size = 5

;; Maximum time a connection can stay idle in the pool before being closed
server_idle_timeout = 600

;; Django compatibility settings
;; Django sends extra_float_digits parameter that pgBouncer doesn't recognize
;; This tells pgBouncer to ignore it instead of rejecting the connection
ignore_startup_parameters = extra_float_digits

;; Logging configuration
;; Set to 1 for production, 2 for debugging connection issues
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

;; Admin console configuration
;; Accessible via: psql -h localhost -p 6432 -U postgres -d pgbouncer
admin_users = postgres

;; DNS configuration
;; Use system DNS for resolving hostnames
;; Important for Docker service name resolution (db -> IP)
server_reset_query = DISCARD ALL
server_check_delay = 30
