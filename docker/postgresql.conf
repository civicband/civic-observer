# PostgreSQL Configuration for Civic Observer
# Optimized for 8GB RAM server with 100M+ pages
# Generated: 2025-11-19

# =============================================================================
# MEMORY CONFIGURATION
# =============================================================================
# Rule of thumb for 8GB RAM dedicated PostgreSQL server:
# - shared_buffers: 25% of RAM = 2GB
# - effective_cache_size: 75% of RAM = 6GB
# - work_mem: Conservative to avoid OOM = 32MB
# - maintenance_work_mem: For index/VACUUM = 512MB

shared_buffers = 2GB
effective_cache_size = 6GB
work_mem = 32MB
maintenance_work_mem = 512MB

# =============================================================================
# CONNECTION CONFIGURATION
# =============================================================================
# Higher max_connections since we're using pgBouncer for pooling
# pgBouncer will handle client connections and maintain smaller pool to PostgreSQL

max_connections = 200

# =============================================================================
# WRITE-AHEAD LOG (WAL) CONFIGURATION
# =============================================================================
# Optimize for reliability and performance

wal_buffers = 16MB
checkpoint_completion_target = 0.9
min_wal_size = 1GB
max_wal_size = 4GB

# =============================================================================
# QUERY PLANNER CONFIGURATION
# =============================================================================
# Optimize for SSD storage (lower random_page_cost)
# Enable parallel query execution

random_page_cost = 1.1              # Default 4.0 is for HDDs, 1.1 for SSDs
effective_io_concurrency = 200      # For SSDs with parallel I/O
seq_page_cost = 1.0

# Parallel query execution
max_parallel_workers_per_gather = 2
max_parallel_workers = 4
max_worker_processes = 4

# =============================================================================
# AUTOVACUUM TUNING
# =============================================================================
# Critical for large tables (100M+ rows)
# More aggressive autovacuum to prevent table bloat

autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 10s                    # Check more frequently (default 60s)
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.05       # VACUUM at 5% changes (default 20%)
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.02      # ANALYZE at 2% changes (default 10%)
autovacuum_vacuum_cost_delay = 2ms          # Reduce I/O impact
autovacuum_vacuum_cost_limit = 1000

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================
# Log slow queries and important events for monitoring

logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB

# Log slow queries (>1 second)
log_min_duration_statement = 1000

# Detailed logging prefix
log_line_prefix = '%t [%p]: user=%u,db=%d,app=%a,client=%h '

# Log important events
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0

# =============================================================================
# FULL-TEXT SEARCH OPTIMIZATION
# =============================================================================
# Optimize for our full-text search workload

# Increase default statistics target for better query planning
default_statistics_target = 500

# =============================================================================
# PERFORMANCE EXTENSIONS
# =============================================================================
# Enable pg_stat_statements for query performance monitoring
# Note: Disabled for now as it may not be available in Alpine-based PostgreSQL
# shared_preload_libraries = 'pg_stat_statements'
# pg_stat_statements.track = all
# pg_stat_statements.max = 10000

# =============================================================================
# REPLICATION (FUTURE)
# =============================================================================
# Settings for potential future read replicas
# Currently unused but configured for easy enablement

wal_level = replica
max_wal_senders = 3
max_replication_slots = 3

# =============================================================================
# ADDITIONAL OPTIMIZATIONS
# =============================================================================

# Reduce planner overhead for simple queries
geqo = on
geqo_threshold = 12

# Optimize for write-heavy workloads
commit_delay = 0
commit_siblings = 5

# Increase timeout for long-running maintenance operations
statement_timeout = 0                      # No timeout by default (app sets this)
idle_in_transaction_session_timeout = 600000   # 10 minutes
